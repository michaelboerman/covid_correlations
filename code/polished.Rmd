---
title: "Covid Correlation with Population Density"
output:
  html_document:
    df_print: paged
  html_notebook: default
  word_document: default
---

Set up libraries and such:
```{r, message=FALSE, warning = FALSE}
library(here)
library(readxl)
library(tidyverse)
library(lubridate)
library(countrycode)

# For data about deaths and cases
library(COVID19)

# For GGplot aestehtics
library(extrafont)
library(scales)
library(latex2exp)
```

## Research Question: Does population density correlate with COVID-19 deaths or cases?

It seems logical that with a transmutable disease, such as the highly-infectious coronavrius, that a higher population desnity would facillitate higher cases or deaths. I'd like to explore this theory in the data. 

First, I'll read in population densities for 264 countries. This data is static throughout 2020, such that the density for January 1st is the reported the same as December 31. This may not be true, but country-wide populaiton count is not a particuarly high-frequency time series, so I'm grateful we have any metric whatsoever. 

```{r, message=FALSE, warning = FALSE}
# Read in densities
# Data comes from https://population.un.org/wpp/Download/Standard/Population/ 
density <- read_csv(here("data_input/pop_density.csv"),
                    skip = 4) %>% 
  
  # drop everything except two columns, and rename while we're here
  transmute(country = `Country Name`,
            country_code = `Country Code`,
            density = `2018`) %>%
  
  # if it doesn't have a density estimate, drop it. 
  drop_na(density) %>% 
  
  # Add in the numeric country code, for use late.
  mutate(country_code_num = countrycode(country_code, 
                                        origin = "iso3c", 
                                        destination = "iso3n",
                                        nomatch = NA)) %>% 
  identity()

# in developement, I also read-in population counts. This is not needed in the
# final product, but I'll carry over the naming convention
country_pops <- density
```


Next, we need to load the covid data -- notably, the number of cases and deaths.

```{r}
# See this incredible package https://cran.r-project.org/web/packages/COVID19/index.html

covid_data <- COVID19::covid19(verbose = FALSE) %>% 
  
  # rename to match what we have in country_pops dataframe
  rename(country_code = id) %>% 
  
  # and now join using this column
  left_join(country_pops, by = "country_code") %>% 
  identity()

# idea: pick a random date and plot density vs deaths or cases
# covid_data %>% 
#   group_by(date) %>% 
#   # slice_sample(n = 1) %>% 
#   drop_na(confirmed, deaths) %>% 
#   head() %>% 
#   drop_na(confirmed) %>% 
#   filter(confirmed > 0) %>%
#   # filter(density < 1000) %>% 
#   # filter(confirmed < 40000) %>% 
#   ggplot(aes(x = deaths, y = density)) +
#   coord_trans(x = "log10", y = "log10") +
#   geom_point(na.rm = T) + 
#   # geom_smooth(na.rm = T) +
#   NULL
    
```

Now, let's look at a pure pearson's correlation to see how these two move together. 
```{r}
cor.test(covid_data$density, covid_data$deaths, method = "pearson")
cor.test(covid_data$density, covid_data$confirmed, method = "pearson")

```
Look at this! The correlation, in both cases, is most likely 0. We have a high degree of confidence they don't move together at all. 

However, this is aggregated acros *all* dates. Maybe the correlation *was* high, but with better lockdown measures or vaccine distribution, the correlation changes over time. 

Let's grab each correlation for a given date. In this dataframe, we have between 175 and 200 countries with complete data for any given date. This should be large enough to support a correlation test. 
```{r}

# Grab the individual dates out of our long dataframe
  unique_dates <- unique(covid_data$date)

# sort by date, such that Jan 2021 will come at the end, not beginning
  unique_dates <- unique_dates[order(unique_dates)]

# skip Jan 2020
  unique_dates <- unique_dates[33:length(unique_dates)-1]
  
# I can't wait for R 4.1 native pipes... :)

# initialize a DF to put in each date's correlation
  cors_over_time <- data.frame(
    "date" = unique_dates,
    "death_cor" = rep(NA, length(unique_dates)),
    "case_cor" = rep(NA, length(unique_dates))
    )
# for loop for calculating correlation per date
  for (i in 1:length(unique_dates)) {
    
    # grab the data frame for that date i
    filtered_date_data <- covid_data %>% 
      filter(date == unique_dates[i]) %>% 
      identity()
    
    # insert correlation between pop density and deaths
    cors_over_time$death_cor[i] <- cor(filtered_date_data$density, filtered_date_data$deaths, use = "complete.obs")
    
    # insert correlation between pop density and confirmed cases
    cors_over_time$case_cor[i] <- cor(filtered_date_data$density, filtered_date_data$confirmed, use = "complete.obs")
    
  }

```

Now, let's plot!
```{r, warning=FALSE, message = FALSE}
# plot for correlation between pop density adn deaths
cors_over_time %>% 
  ggplot(aes(x = date))+
  geom_line(aes(y = death_cor)) + 
  theme_minimal() +
  geom_hline(yintercept = 0)+
  geom_hline(yintercept = mean(cors_over_time$death_cor),
             linetype = "dashed", color = "gray")+
  scale_y_continuous(expand = expand_scale(mult = 0),
                     limits = c(-0.25, 0)) +
  scale_x_date(expand = expand_scale(mult = 0)) +
  labs(title = "Correlation between Population Density and COVID Deaths",
       subtitle = "Filtered by date",
       caption = "Source: UN Population Dynamics, Oxford COVID-19 Government Response Tracker. \n Chart: Michael Boerman, https://github.com/michaelboerman") +
  ylab("Correlation") +
  theme(text = element_text(family="serif"),
        axis.title.x = element_blank(),
        axis.line.y = element_line()) +
  ggsave(filename = here("plots/cor_density_deaths.jpg"))
```

Repeat, but for covid cases:
```{r}
# Likewise, but for cases
cors_over_time %>% 
  ggplot(aes(x = date))+
  geom_line(aes(y = case_cor)) + 
  theme_minimal() +
  geom_hline(yintercept = 0)+
  geom_hline(yintercept = mean(cors_over_time$case_cor),
             linetype = "dashed", color = "gray")+
  scale_y_continuous(expand = expand_scale(mult = 0),
                     limits = c(-0.25, 0)) +
  scale_x_date(expand = expand_scale(mult = 0)) +
  labs(title = "Correlation between Population Density and COVID Cases",
       subtitle = "Filtered by date",
       caption = "Source: UN Population Dynamics, Oxford COVID-19 Government Response Tracker. \n Chart: Michael Boerman, https://github.com/michaelboerman") +
  ylab("Correlation") +
  theme(text = element_text(family="serif"),
        axis.title.x = element_blank(),
        axis.line.y = element_line()) +
  ggsave(filename = here("plots/cor_density_cases.jpg"))
```

